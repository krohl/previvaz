from datetime import date, timedelta

from chuva_vazao_utils.aws.s3_client import S3Client
from chuva_vazao_utils.entities.inflow.origin_type import OriginTypeMenu
from chuva_vazao_utils.database_access.inflows.inflow import InflowDatabaseApi
from chuva_vazao_utils.database_access.inflows.origin_type import OriginTypeDatabaseApi


def check_acomph(ref_date: date, bucket_name: str) -> bool:
    s3_client = S3Client()
    yesterday = (ref_date - timedelta(days=1))
    acomph_prefix = yesterday.strftime("realizado/dados/ONS/Acompanhamento_Hidrologico/%Y/%m/")
    key = acomph_prefix + yesterday.strftime('Acomp_Hidrologico_%Y%m%d.xlsx')
    exists_in_s3 = s3_client.check_key_exists(key, bucket_name)

    inflow_origin_acomph = OriginTypeDatabaseApi.fetch_origin_type(OriginTypeMenu.ACOMPH)
    exists_on_db = InflowDatabaseApi.check_inflow_origin_was_loaded_on_date(inflow_origin_acomph, ref_date)

    return exists_in_s3 and exists_on_db
