from chuva_vazao_utils import query
from chuva_vazao_utils.connection import RiverDatabase
from chuva_vazao_utils.utils.cacheutils import timed_lru_cache
from chuva_vazao_utils.database_access.table_base import TableBase
from chuva_vazao_utils.database_access.query_formatter import NOT_NULL


@timed_lru_cache(seconds=300)
def fetch_power_plants():
    cursor = RiverDatabase.execute(query.POWER_PLANTS_QUERY)
    return cursor.fetchall()


@timed_lru_cache(seconds=300)
def fetch_codigo_ana_smap():
    PowerPlant = TableBase.from_tablename('PowerPlant', 'power_plant')
    cols = ['codigo_ana']
    condition = {'smap_flag': 1, 'end_date': None, 'codigo_ana': NOT_NULL}
    return PowerPlant.select(columns=cols, where=condition)
