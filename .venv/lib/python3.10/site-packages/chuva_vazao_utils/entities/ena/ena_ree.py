from abc import ABC, abstractmethod
from dataclasses import dataclass
from typing import List, Optional, Union

from chuva_vazao_utils.entities.inflow.origin_type import OriginType
from chuva_vazao_utils.entities.inflow.inflow_source import InflowSource
from chuva_vazao_utils.entities.power_plant.ree import ReservatorioEquivalente
from chuva_vazao_utils.entities.smap.round import SmapRound
from chuva_vazao_utils.entities.utils.data import WeeklyValue


@dataclass
class EnaRee(WeeklyValue):
    reservatorio_equivalente: ReservatorioEquivalente
    origin: OriginType
    inflow_source: InflowSource
    id_rodada_smap: Optional[int] = None

    def to_dict(self):
        return {
            'id_reservatorio_equivalente': self.reservatorio_equivalente.id,
            'id_inflow_source': self.inflow_source.id,
            'id_origin_type': self.origin.id,
            'value': self.value,
            'start_date_week': self.op_week.begin_date,
            'end_date_week': self.op_week.end_date,
            'id_rodada_smap': self.id_rodada_smap,
        }


class EnaReeApi(ABC):
    @classmethod
    @abstractmethod
    def persist(cls, ena_vals: Union[EnaRee, List[EnaRee]], auto_commit: bool = True):
        raise NotImplementedError()

    @classmethod
    @abstractmethod
    def fetch_given_smap_round(cls, smap_round: SmapRound) -> List[EnaRee]:
        raise NotImplementedError()
