from datetime import date

from chuva_vazao_utils.aws.s3.environment import Env
from chuva_vazao_utils.aws.s3.s3_models import S3File, S3Folder
from chuva_vazao_utils.entities.remvies.round import RemviesRound, RemviesRoundFilesApi
from chuva_vazao_utils.entities.operative_week import SemanaOperativa


class RemviesRoundS3Api(RemviesRoundFilesApi):

    @classmethod
    def decks_folder(cls, remvies_round: RemviesRound) -> S3Folder:
        bucket_name = Env.bucket_smap
        decks_folder_path = remvies_round.cpu_date.strftime(f'remvies/%Y/%m/%d/{remvies_round.id}/entrada/')
        return S3Folder(decks_folder_path, bucket_name)

    @classmethod
    def deck_file(cls, remvies_round: RemviesRound, op_week: SemanaOperativa) -> S3File:
        decks_folder = cls.decks_folder(remvies_round)

        deck_file_date = max(op_week.round_date, remvies_round.base_date)
        deck_zip_filename = f'remocao_{deck_file_date.strftime("%Y%m%d")}.zip'

        return S3File(decks_folder.base_path, deck_zip_filename, decks_folder.bucket_name)

    @classmethod
    def output_base_folder(cls, remvies_round: RemviesRound) -> S3Folder:
        bucket = Env.bucket_smap
        output_base_folder = remvies_round.cpu_date.strftime(f'remvies/%Y/%m/%d/{remvies_round.id}/saida/')
        return S3Folder(output_base_folder, bucket)

    @classmethod
    def output_folder_op_week(cls, remvies_round: RemviesRound, op_week: SemanaOperativa) -> S3Folder:
        bucket_name = Env.bucket_smap

        output_folder_date = max(op_week.round_date, remvies_round.base_date)
        sman_oper_folder = remvies_round.cpu_date.strftime(
            f'remvies/%Y/%m/%d/{remvies_round.id}/saida/{output_folder_date.strftime("%Y%m%d")}'
        )
        return S3Folder(sman_oper_folder, bucket_name)

    @classmethod
    def output_file_op_week(cls, remvies_round: RemviesRound, op_week: SemanaOperativa, data_date: date) -> S3File:
        output_folder = cls.output_folder_op_week(remvies_round, op_week)
        data_file_name = f'PMEDIA_p{remvies_round.base_date.strftime("%d%m%y")}a{data_date.strftime("%d%m%y")}.dat'

        return S3File(output_folder.base_path, data_file_name, output_folder.bucket_name)
